<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ISCAE RÃ©sultats</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#005C29">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2232/2232688.png">

    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- Ù…ÙƒØªØ¨Ø© Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --primary: #005C29;
            --secondary: #FFD700;
            --bg-gradient: linear-gradient(135deg, #f0fdf4 0%, #e6f7ed 100%);
            --text: #1a2e1a;
            --radius: 15px;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-gradient); margin: 0; padding: 15px; color: var(--text); direction: rtl; padding-bottom: 50px; }
        
        header { 
            background: var(--primary); color: white; padding: 20px 15px; 
            text-align: center; border-bottom: 4px solid var(--secondary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 0 0 15px 15px;
            cursor: pointer; user-select: none;
        }

        header h1 { margin: 0; font-size: 1.8rem; pointer-events: none; }
        
        .top-dev {
            color: var(--secondary); font-size: 0.9rem; margin-top: 5px;
            font-weight: bold; letter-spacing: 0.5px; opacity: 0.9;
        }
        
        .container { max-width: 800px; margin: 20px auto; padding: 5px; }
        
        .search-box { 
            background: white; padding: 25px; border-radius: var(--radius); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 30px;
        }

        .form-group { margin-bottom: 15px; text-align: right; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary); }
        
        select, input { 
            width: 100%; padding: 12px; border: 2px solid #bbf7d0; 
            border-radius: 10px; font-size: 1rem; box-sizing: border-box; outline: none;
        }
        select:focus, input:focus { border-color: var(--primary); }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        
        button { 
            flex: 1; padding: 15px; border: none; border-radius: 10px; 
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        
        .btn-search { background: var(--primary); color: white; }
        .btn-top20 { background: var(--secondary); color: #004d22; }
        button:hover { transform: translateY(-2px); opacity: 0.95; }

        .result-card { 
            background: white; border-radius: var(--radius); padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: none; 
            animation: slideUp 0.5s ease; margin-bottom: 30px;
            border-top: 6px solid var(--primary); text-align: right;
        }

        .student-info h2 { color: var(--primary); margin: 0 0 20px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1.1rem; }
        .info-val { font-weight: bold; color: #000; }

        .decision-valid { color: #059669; background: #d1fae5; padding: 2px 8px; border-radius: 5px; }
        .decision-ratt { color: #dc2626; background: #fee2e2; padding: 2px 8px; border-radius: 5px; }

        .download-btn {
            display: block; width: 100%; text-align: center; 
            background: #1e293b; color: white; padding: 15px; 
            text-decoration: none; border-radius: 10px; margin-top: 25px;
            font-weight: bold; transition: 0.3s; box-sizing: border-box; cursor: pointer; border: none;
        }
        .download-btn:hover { background: #334155; }
        .download-btn.loading { background: #94a3b8; cursor: wait; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; direction: ltr; }
        th { background: #f0fdf4; color: var(--primary); padding: 12px; text-align: left; border-bottom: 2px solid var(--primary); }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        tr:nth-child(even) { background: #fafafa; }
        
        .loader { display: none; text-align: center; padding: 20px; font-weight: bold; color: var(--primary); }
        .error { color: #dc2626; text-align: center; display: none; margin-top: 10px; padding: 15px; background: #fee2e2; border-radius: 8px; border: 1px solid #fecaca; }

        .clickable-id { color: var(--primary); text-decoration: underline; font-weight: bold; cursor: pointer; }
        
        /* Modal Style for Admin */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 500px; text-align: right;
            border: 2px solid var(--secondary);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .modal-box h2 { color: var(--primary); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .admin-btn { background: #0f172a; color: #fbbf24; margin-top: 10px; width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .close-modal { 
            float: left; cursor: pointer; font-size: 1.5rem; color: #aaa; 
        }
        .file-input-wrapper { margin-top: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px dashed #cbd5e1; }
        
        /* Celebration */
        #celebration-msg {
            display: none; position: relative; text-align: center;
            background: linear-gradient(135deg, #fff0f5, #fff);
            padding: 25px; border-radius: 15px; margin-top: 20px;
            border: 2px solid #bbf7d0; overflow: hidden; 
            box-shadow: 0 5px 15px rgba(22, 163, 74, 0.2);
        }
        .congrats-text {
            display: block; color: #16a34a; font-size: 1.8rem;
            font-weight: 900; text-shadow: 1px 1px 0 #fff;
            position: relative; z-index: 10;
            animation: bounceIn 1s infinite alternate;
        }
        .floating-particle {
            position: fixed; font-size: 2rem;
            animation: floatUp linear forwards; opacity: 1; z-index: 1000;
            pointer-events: none;
        }

        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translateY(-100vh) rotate(360deg) scale(0.3); opacity: 0; } }
        @keyframes bounceIn { from { transform: scale(1); } to { transform: scale(1.1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 600px) { .btn-group { flex-direction: column; } .info-row { font-size: 1rem; } }

    </style>
</head>
<body>

<header id="main-header">
    <h1>ğŸ“ ISCAE RÃ©sultats</h1>
    <div class="top-dev">UNEM ISCAE</div>
</header>

<!-- Admin Login & Upload Modal -->
<div id="admin-modal" class="modal-overlay">
    <div class="modal-box">
        <span class="close-modal" onclick="closeAdmin()">âœ–</span>
        
        <!-- Step 1: Login -->
        <div id="admin-login-step">
            <h2>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <div class="form-group">
                <label>Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                <input type="password" id="admin-pass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ">
            </div>
            <button class="admin-btn" onclick="checkAdminPass()">Ø¯Ø®ÙˆÙ„</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­!</p>
        </div>

        <!-- Step 2: Upload -->
        <div id="admin-upload-step" style="display:none;">
            <h2>ğŸ“¤ Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
            <div class="form-group">
                <label>Ø§Ù„ØªØ®ØµØµ:</label>
                <select id="up-major">
                    <option value="BA">Banque Assurance (BA)</option>
                    <option value="FC">Finance ComptabilitÃ© (FC)</option>
                    <option value="GRH">Gestion des RH (GRH)</option>
                    <option value="IG">Informatique de Gestion (IG)</option>
                    <option value="TCM">Techniques Commerciales (TCM)</option>
                    <option value="SAE">SAE</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
                <select id="up-level" onchange="updateUploadSemesters()">
                    <option value="L1">Licence 1 (L1)</option>
                    <option value="L2">Licence 2 (L2)</option>
                    <option value="L3">Licence 3 (L3)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„ÙØµÙ„ / Ø§Ù„Ù†ÙˆØ¹:</label>
                <select id="up-semester">
                    <!-- Populated by JS -->
                </select>
            </div>
            
            <div class="file-input-wrapper">
                <label>ğŸ“„ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Resultat):</label>
                <input type="file" id="file-details" accept="application/pdf">
            </div>
            
            <div class="file-input-wrapper">
                <label>ğŸ† Ù…Ù„Ù Ø§Ù„ØªØ±ØªÙŠØ¨ (Classement):</label>
                <input type="file" id="file-ranking" accept="application/pdf">
            </div>

            <button class="admin-btn" style="margin-top:20px; background:var(--primary); color:white;" onclick="uploadFiles()">Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <div id="upload-status" style="margin-top:15px; font-weight:bold; font-size:0.9rem;"></div>
        </div>
    </div>
</div>

<div class="container">
    <div class="search-box">
        <form id="searchForm">
            <div class="form-group">
                <label>Ø§Ù„ØªØ®ØµØµ (FiliÃ¨re)</label>
                <select id="major" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ --</option>
                    <option value="BA">Banque Assurance (BA)</option>
                    <option value="FC">Finance ComptabilitÃ© (FC)</option>
                    <option value="GRH">Gestion des RH (GRH)</option>
                    <option value="IG">Informatique de Gestion (IG)</option>
                    <option value="TCM">Techniques Commerciales (TCM)</option>
                    <option value="SAE">SAE</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Niveau)</label>
                <select id="level" onchange="updateSemesters()" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ --</option>
                    <option value="L1">Licence 1 (L1)</option>
                    <option value="L2">Licence 2 (L2)</option>
                    <option value="L3">Licence 3 (L3)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„ÙØµÙ„ (Semestre)</label>
                <select id="semester" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹ --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Matricule)</label>
                <input type="text" id="matricule" placeholder="Ù…Ø«Ø§Ù„: I21180" style="text-transform: uppercase; text-align: left; direction: ltr;">
            </div>
            <div class="btn-group">
                <button type="button" class="btn-search" onclick="searchStudent()">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                <button type="button" class="btn-top20" onclick="showTop20()">ğŸ† Ø§Ù„Ø¹Ø´Ø±ÙˆÙ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</button>
            </div>
        </form>
        <!-- Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ Ø¹Ø§Ù… ÙˆÙ„Ø§ ÙŠØ°ÙƒØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± -->
        <div id="loader" class="loader">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬...</div>
        <div id="error-msg" class="error"></div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
    <div id="student-result" class="result-card">
        <div class="student-info">
            <h2 id="res-name">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
            <div class="info-row"><span>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span> <span id="res-id" class="info-val"></span></div>
            <div class="info-row"><span>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…:</span> <span id="res-avg" class="info-val" style="color:var(--primary); font-size:1.3rem;"></span></div>
            <!-- Ø®Ø§Ù†Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
            <div class="info-row" id="res-credit-row" style="display:none;"><span>Ø§Ù„Ø±ØµÙŠØ¯ (CrÃ©dits):</span> <span id="res-credit" class="info-val" style="color:var(--primary); font-weight:bold;"></span></div>
            <div class="info-row"><span>Ø§Ù„ØªØ±ØªÙŠØ¨:</span> <span id="res-rank" class="info-val" style="color:var(--secondary);"></span></div>
            <div class="info-row"><span>Ø§Ù„Ù‚Ø±Ø§Ø±:</span> <span id="res-dec" class="info-val"></span></div>
        </div>

        <div id="celebration-msg">
            <span class="congrats-text">ğŸ‰ Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„Ù†Ø¬Ø§Ø­ ğŸ‰</span>
        </div>
        
        <button id="download-btn" class="download-btn" onclick="downloadPrecisePDF()">
            ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø§Ø· (Ù†Ø³Ø®Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙ‚Ø·)
        </button>
        <div id="dl-msg" style="text-align:center; font-size:0.8rem; color:#666; margin-top:5px; display:none;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„Ù‚Øµ Ø§Ù„Ø¯Ù‚ÙŠÙ‚...</div>
    </div>

    <div id="top20-container" class="result-card">
        <h2 style="color:var(--primary); text-align:center;">ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø´Ø±ÙˆÙ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Matricule</th>
                        <th>Nom et PrÃ©nom</th>
                        <th>Moyenne</th>
                    </tr>
                </thead>
                <tbody id="top20-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase & GitHub
    // ==========================================
    const SUPABASE_URL = 'https://chjxwcliodlevzorjush.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoanh3Y2xpb2RsZXZ6b3JqdXNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MjUzNDIsImV4cCI6MjA3OTMwMTM0Mn0.PVvBRAMsscwbnDQt5Qg6Ni9z39WeI981aBCkMnZOnJQ';
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub (Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    const GITHUB_USERNAME = "i21567etu-coder";
    const REPO_NAME = "Resultat-ISCAE-";

    // ØªÙ‡ÙŠØ¦Ø© Supabase
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    // ==========================================

    let currentStudentId = "";
    let currentResultsPdfUrl = "";
    const ADMIN_PASS = "I21567@MDA"; // ğŸ”’ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
        });
    }

    // 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ (ØªÙ… Ø¥Ø²Ø§Ù„Ø© RÃ©sultat Annuel)
    const semsData = {
        'L1': { 'S1': 'Semestre 1', 'S2': 'Semestre 2' },
        'L2': { 'S3': 'Semestre 3', 'S4': 'Semestre 4' },
        'L3': { 'S5': 'Semestre 5', 'S6': 'Semestre 6' }
    };

    function updateSemesters() {
        populateSemesters('level', 'semester');
    }
    
    function updateUploadSemesters() {
        populateSemesters('up-level', 'up-semester');
    }

    function populateSemesters(levelId, semId) {
        const lvl = document.getElementById(levelId).value;
        const semSelect = document.getElementById(semId);
        semSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ / Ø§Ù„Ù†ÙˆØ¹ --</option>';
        if(lvl && semsData[lvl]) {
            for(let key in semsData[lvl]) {
                let opt = document.createElement('option');
                opt.value = key; 
                opt.text = semsData[lvl][key];
                semSelect.appendChild(opt);
            }
        }
    }

    // ==========================================
    // ğŸ“ ADMIN LOGIC (5 Taps)
    // ==========================================
    let tapCount = 0;
    const header = document.getElementById('main-header');
    
    header.addEventListener('click', (e) => {
        tapCount++;
        if (tapCount === 5) {
            document.getElementById('admin-modal').style.display = 'flex';
            tapCount = 0;
        }
        setTimeout(() => tapCount = 0, 2000);
    });

    function closeAdmin() {
        document.getElementById('admin-modal').style.display = 'none';
        document.getElementById('admin-login-step').style.display = 'block';
        document.getElementById('admin-upload-step').style.display = 'none';
        document.getElementById('admin-pass').value = '';
    }

    function checkAdminPass() {
        const input = document.getElementById('admin-pass').value;
        if (input === ADMIN_PASS) {
            document.getElementById('admin-login-step').style.display = 'none';
            document.getElementById('admin-upload-step').style.display = 'block';
            updateUploadSemesters();
        } else {
            const err = document.getElementById('login-error');
            err.style.display = 'block';
            setTimeout(() => err.style.display = 'none', 2000);
        }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹
    async function uploadFiles() {
        const statusDiv = document.getElementById('upload-status');
        const major = document.getElementById('up-major').value;
        const level = document.getElementById('up-level').value;
        const semester = document.getElementById('up-semester').value;
        
        const fileDetails = document.getElementById('file-details').files[0];
        const fileRanking = document.getElementById('file-ranking').files[0];

        if (!major || !level || !semester || !fileDetails || !fileRanking) {
            statusDiv.innerHTML = '<span style="color:red">ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙÙŠÙ†.</span>';
            return;
        }

        statusDiv.innerHTML = '<span style="color:#005C29">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.</span>';

        try {
            const uploadToSupabase = async (file, prefix) => {
                const fileName = `${prefix}_${major}_${level}_${semester}_${Date.now()}.pdf`;
                const { data, error } = await _supabase.storage
                    .from('isc_results')
                    .upload(fileName, file);
                
                if (error) throw error;
                const { data: urlData } = _supabase.storage
                    .from('isc_results')
                    .getPublicUrl(fileName);
                return urlData.publicUrl;
            };

            const detailsUrl = await uploadToSupabase(fileDetails, 'DETAILS');
            const rankingUrl = await uploadToSupabase(fileRanking, 'RANKING');

            const { error: dbError } = await _supabase
                .from('results_metadata')
                .insert([
                    { major: major, level: level, semester: semester, details_url: detailsUrl, ranking_url: rankingUrl }
                ]);

            if (dbError) throw dbError;

            statusDiv.innerHTML = '<span style="color:green">âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†.</span>';
            setTimeout(() => {
                closeAdmin();
                statusDiv.innerHTML = '';
            }, 3000);

        } catch (err) {
            console.error(err);
            statusDiv.innerHTML = '<span style="color:red">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (err.message || JSON.stringify(err)) + '</span>';
        }
    }

    // ==========================================
    // ğŸ” STUDENT SEARCH LOGIC
    // ==========================================

    async function fetchLatestFiles() {
        const major = document.getElementById('major').value;
        const lvl = document.getElementById('level').value;
        const sem = document.getElementById('semester').value;
        
        if(!major || !lvl || !sem) { 
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®ØµØµØŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„ÙØµÙ„."); 
            return null; 
        }

        try {
            const { data, error } = await _supabase
                .from('results_metadata')
                .select('*')
                .eq('major', major)
                .eq('level', lvl)
                .eq('semester', sem)
                .order('created_at', { ascending: false })
                .limit(1);

            if (data && data.length > 0) {
                return {
                    rankingUrl: data[0].ranking_url,
                    resultsUrl: data[0].details_url
                };
            }
        } catch (err) {
            console.log("Supabase check failed, falling back...");
        }

        const filePrefix = `${major}_${lvl}_${sem}`;
        const baseUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/main`;
        
        return {
            rankingUrl: `${baseUrl}/${filePrefix}_Resultats_Classement.pdf`,
            resultsUrl: `${baseUrl}/${filePrefix}_Resultats.pdf`
        };
    }

    function resetView() {
        document.getElementById('student-result').style.display = 'none';
        document.getElementById('top20-container').style.display = 'none';
        document.getElementById('error-msg').style.display = 'none';
        document.getElementById('dl-msg').style.display = 'none';
        const celebBox = document.getElementById('celebration-msg');
        celebBox.style.display = 'none';
        document.querySelectorAll('.floating-particle').forEach(p => p.remove());
    }

    async function fetchRankingData(pdfUrl) {
        try {
            const loadingTask = pdfjsLib.getDocument(pdfUrl);
            const pdf = await loadingTask.promise;
            let students = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                let rows = []; 
                textContent.items.forEach(item => {
                    const y = item.transform[5]; 
                    const str = item.str;
                    const x = item.transform[4];
                    let foundRow = rows.find(r => Math.abs(r.y - y) < 5);
                    if (foundRow) foundRow.items.push({ str, x });
                    else rows.push({ y, items: [{ str, x }] });
                });

                rows.sort((a, b) => b.y - a.y);

                rows.forEach(row => {
                    const lineItems = row.items.sort((a, b) => a.x - b.x);
                    const lineStr = lineItems.map(t => t.str).join(" ").trim();
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ (Credits)
                    // Ø§Ù„Ù†Ù…Ø·: Rank - ID - Name - Average - Credits - Decision
                    let match = lineStr.match(/^(\d+)\s+(I\d+)\s+(.+?)\s+(\d{1,2}(?:[.,]\d{1,2})?)\s+(\d{1,2})\s+(.+)$/i);
                    let hasCredit = true;
                    
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ·Ø§Ø¨Ù‚ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¨Ø¯ÙˆÙ† Ø±ØµÙŠØ¯)
                    if (!match) {
                        match = lineStr.match(/^(\d+)\s+(I\d+)\s+(.+?)\s+(\d{1,2}(?:[.,]\d{1,2})?)\s+(.+)$/i);
                        hasCredit = false;
                    }
                    
                    if(match) {
                        students.push({
                            rank: parseInt(match[1]),
                            id: match[2].toUpperCase(),
                            name: match[3].trim(),
                            avg: match[4].replace(',', '.'),
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£ÙˆÙ„ (hasCredit) ÙØ§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© 5 ÙˆØ§Ù„Ù‚Ø±Ø§Ø± ÙÙŠ 6
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø«Ø§Ù†ÙŠØŒ ÙØ§Ù„Ù‚Ø±Ø§Ø± ÙÙŠ 5 ÙˆØ§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                            credit: hasCredit ? match[5] : null, 
                            decision: hasCredit ? match[6].trim() : match[5].trim()
                        });
                    }
                });
            }
            return students;
        } catch (e) {
            console.error("PDF Parse Error:", e);
            return null;
        }
    }

    async function searchStudent() {
        resetView();
        document.getElementById('loader').style.display = 'block';

        const matricule = document.getElementById('matricule').value.trim().toUpperCase();
        if(!matricule) { 
            document.getElementById('loader').style.display = 'none';
            document.getElementById('error-msg').innerText = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„.";
            document.getElementById('error-msg').style.display = 'block';
            return; 
        }

        const urls = await fetchLatestFiles();
        
        if(!urls) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('error-msg').innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.";
            return;
        }

        const students = await fetchRankingData(urls.rankingUrl);
        document.getElementById('loader').style.display = 'none';

        if(!students) {
            document.getElementById('error-msg').innerText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®ØµØµ Ø§Ù„ØµØ­ÙŠØ­).";
            document.getElementById('error-msg').style.display = 'block';
            return;
        }

        const student = students.find(s => s.id === matricule);

        if(student) {
            document.getElementById('res-name').innerText = student.name;
            document.getElementById('res-id').innerText = student.id;
            document.getElementById('res-avg').innerText = student.avg;
            document.getElementById('res-rank').innerText = student.rank;
            
            // Ø¹Ø±Ø¶ Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ Ø®Ø§Ù†Ø© Ø§Ù„Ø±ØµÙŠØ¯
            const creditRow = document.getElementById('res-credit-row');
            if (student.credit) {
                document.getElementById('res-credit').innerText = student.credit;
                creditRow.style.display = 'flex';
            } else {
                creditRow.style.display = 'none';
            }

            const decEl = document.getElementById('res-dec');
            decEl.innerText = student.decision;
            
            const decText = student.decision.toLowerCase();
            const isValid = decText.includes('valid') || decText.includes('admis');
            decEl.className = isValid ? 'info-val decision-valid' : 'info-val decision-ratt';

            currentStudentId = student.id;
            currentResultsPdfUrl = urls.resultsUrl;
            
            const card = document.getElementById('student-result');
            card.style.display = 'block';
            if (isValid) startCelebration();
            setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        } else {
            document.getElementById('error-msg').innerText = "Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.";
            document.getElementById('error-msg').style.display = 'block';
        }
    }

    async function showTop20() {
        resetView();
        document.getElementById('loader').style.display = 'block';

        const urls = await fetchLatestFiles();
        if(!urls) {
            document.getElementById('loader').style.display = 'none';
            return;
        }

        const students = await fetchRankingData(urls.rankingUrl);
        document.getElementById('loader').style.display = 'none';
        
        if(!students) {
            document.getElementById('error-msg').innerText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬.";
            document.getElementById('error-msg').style.display = 'block';
            return;
        }

        students.sort((a,b) => a.rank - b.rank);
        const top20 = students.slice(0, 20);

        const tbody = document.getElementById('top20-body');
        tbody.innerHTML = '';

        if(top20.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©.</td></tr>';
        } else {
            top20.forEach(s => {
                const row = `
                    <tr>
                        <td><b>${s.rank}</b></td>
                        <td><a onclick="triggerQuickSearch('${s.id}')" class="clickable-id">${s.id}</a></td>
                        <td>${s.name}</td>
                        <td style="color:var(--primary); font-weight:bold;">${s.avg}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        const topContainer = document.getElementById('top20-container');
        topContainer.style.display = 'block';
        setTimeout(() => topContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }

    function triggerQuickSearch(id) {
        document.getElementById('matricule').value = id;
        searchStudent();
    }

    // Ø§Ù„Ø§Ø­ØªÙØ§Ù„
    function startCelebration() {
        const container = document.getElementById('celebration-msg');
        container.style.display = 'block';
        const symbols = ['ğŸŒ¹', 'â¤ï¸', 'ğŸ’–', 'ğŸ’', 'âœ¨', 'ğŸŒ¸', 'ğŸ’•', 'ğŸ‰', 'â­', 'ğŸ’'];
        for (let i = 0; i < 50; i++) {
            const span = document.createElement('span');
            span.classList.add('floating-particle');
            span.innerText = symbols[Math.floor(Math.random() * symbols.length)];
            span.style.left = Math.random() * 100 + '%';
            span.style.top = Math.random() * 50 + 50 + '%';
            span.style.animationDuration = (Math.random() * 3 + 3) + 's';
            span.style.animationDelay = Math.random() * 2 + 's';
            span.style.fontSize = (Math.random() * 2 + 1.5) + 'rem';
            document.body.appendChild(span);
            setTimeout(() => { span.remove(); }, 6000);
        }
    }

    // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù (Ù‚Øµ Ø¯Ù‚ÙŠÙ‚)
    async function downloadPrecisePDF() {
        if (!currentStudentId || !currentResultsPdfUrl) return;

        const btn = document.getElementById('download-btn');
        const msg = document.getElementById('dl-msg');
        btn.disabled = true;
        btn.classList.add('loading');
        btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
        msg.style.display = 'block';

        try {
            const existingPdfBytes = await fetch(currentResultsPdfUrl).then(res => {
                if (!res.ok) throw new Error("File not found");
                return res.arrayBuffer();
            });
            
            const loadingTask = pdfjsLib.getDocument({ data: existingPdfBytes });
            const pdfDocjs = await loadingTask.promise;
            
            let startPage = -1, startY = 0, endY = 0, spansToNextPage = false, nextPageEndY = 0;

            for (let i = 1; i <= pdfDocjs.numPages; i++) {
                const page = await pdfDocjs.getPage(i);
                const content = await page.getTextContent();
                for (let item of content.items) {
                    if (item.str.includes(currentStudentId)) {
                        startPage = i - 1;
                        startY = item.transform[5];
                        let nextStudents = content.items.filter(itm => itm.str.match(/I\d{4,}/) && itm.transform[5] < startY);
                        if (nextStudents.length > 0) {
                            nextStudents.sort((a, b) => b.transform[5] - a.transform[5]);
                            endY = nextStudents[0].transform[5]; 
                        } else {
                            endY = 30; 
                            if (i < pdfDocjs.numPages) {
                                const nextPage = await pdfDocjs.getPage(i + 1);
                                const nextContent = await nextPage.getTextContent();
                                let page2Students = nextContent.items.filter(itm => itm.str.match(/I\d{4,}/));
                                if (page2Students.length > 0) {
                                    spansToNextPage = true;
                                    page2Students.sort((a, b) => b.transform[5] - a.transform[5]);
                                    nextPageEndY = page2Students[0].transform[5];
                                }
                            }
                        }
                        break;
                    }
                }
                if (startPage !== -1) break;
            }

            if (startPage === -1) throw new Error("Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„Ù Ø§Ù„ØªÙØ§ØµÙŠÙ„");

            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.load(existingPdfBytes);
            const newPdf = await PDFDocument.create();
            const [page1] = await newPdf.copyPages(pdfDoc, [startPage]);
            const { width, height } = page1.getSize();
            const cropTop = Math.min(height, startY + 60); 
            const cropBottom = spansToNextPage ? 0 : (endY + 10); 
            page1.setCropBox(0, cropBottom, width, cropTop - cropBottom);
            newPdf.addPage(page1);

            if (spansToNextPage) {
                const [page2] = await newPdf.copyPages(pdfDoc, [startPage + 1]);
                const page2Bottom = nextPageEndY + 10;
                page2.setCropBox(0, page2Bottom, width, height - page2Bottom);
                newPdf.addPage(page2);
            }

            const pdfBytes = await newPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Resultat_${currentStudentId}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error(error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØŒ Ø±Ø¨Ù…Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ØªØ§Ù„Ù Ø£Ùˆ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
        } finally {
            btn.disabled = false;
            btn.classList.remove('loading');
            btn.innerText = "ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø§Ø· (Ù†Ø³Ø®Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙ‚Ø·)";
            msg.style.display = 'none';
        }
    }
</script>

<!-- START PROTECTION CODE -->
<script>
    (function() {
        document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false;
            if(e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }
    })();
</script>
<!-- END PROTECTION CODE -->

</body>
</html>